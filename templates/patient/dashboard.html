{% extends 'base.html' %}
{% load static %}

{% block title %}Tableau de bord patient{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
<style>
.card {
    border-radius: 18px;
    box-shadow: 0 2px 16px rgba(0,0,0,0.07);
    border: none;
}

.card-header.bg-primary {
    background: #4fc3f7 !important;
    color: white !important;
    border-top-left-radius: 18px !important;
    border-top-right-radius: 18px !important;
    font-size: 1.1rem;
    font-weight: 600;
    letter-spacing: 0.5px;
}

#map {
    height: 400px;
    width: 100%;
    border-radius: 18px;
    margin-bottom: 1rem;
    z-index: 1;
}

.leaflet-container {
    width: 100%;
    height: 100%;
    border-radius: 18px;
}

.legend {
    background: white;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
}

.legend i {
    width: 18px;
    height: 18px;
    float: left;
    margin-right: 8px;
    opacity: 0.7;
}

.legend-item {
    margin-bottom: 5px;
}

.chat-container {
    height: 350px;
    min-height: 350px;
    max-height: 350px;
    overflow-y: auto;
    padding: 1.5rem 1rem 1rem 1rem;
    background: #f8f9fa;
    border-radius: 0 0 18px 18px;
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
    margin-bottom: 0.5rem;
}

.message {
    display: flex;
    align-items: flex-end;
    gap: 0.5rem;
    max-width: 90%;
}

.user-message {
    margin-left: auto;
    flex-direction: row-reverse;
}

.ai-message {
    margin-right: auto;
}

.message-content {
    padding: 0.85rem 1.2rem;
    border-radius: 18px;
    position: relative;
    font-size: 1.05rem;
    box-shadow: 0 1px 4px rgba(0,0,0,0.04);
}

.user-message .message-content {
    background: #4fc3f7;
    color: white;
    border-top-right-radius: 6px;
    border-bottom-right-radius: 18px;
    border-bottom-left-radius: 18px;
    border-top-left-radius: 18px;
}

.ai-message .message-content {
    background: #e9ecef;
    color: #212529;
    border-top-left-radius: 6px;
    border-bottom-right-radius: 18px;
    border-bottom-left-radius: 18px;
    border-top-right-radius: 18px;
}

@media (max-width: 991px) {
    .chat-container {
        height: 250px;
        min-height: 250px;
        max-height: 250px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Carte des professionnels de santé -->
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        Professionnels de santé à proximité
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div id="map"></div>
                    <div class="legend p-3">
                        <div class="legend-item"><i class="fas fa-user-md" style="color: #007bff;"></i> Médecins</div>
                        <div class="legend-item"><i class="fas fa-flask" style="color: #28a745;"></i> Laboratoires</div>
                        <div class="legend-item"><i class="fas fa-prescription-bottle-alt" style="color: #fd7e14;"></i> Pharmacies</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat IA -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-robot me-2"></i>
                        Assistant IA
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chat-container" id="chatContainer">
                        {% for message in chat_history %}
                            {% if message.is_from_ai %}
                                <div class="message ai-message">
                                    <div class="message-avatar">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <div class="message-content">
                                        {{ message.message|linebreaks }}
                                    </div>
                                </div>
                            {% else %}
                                <div class="message user-message">
                                    <div class="message-content">
                                        {{ message.message|linebreaks }}
                                    </div>
                                    <div class="message-avatar">
                                        <i class="fas fa-user"></i>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <form id="chatForm" class="mt-3">
                        <div class="input-group">
                            <input type="text" id="messageInput" class="form-control" placeholder="Posez votre question...">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Rendez-vous à venir -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>
                        Rendez-vous à venir
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        {% for rdv in rendez_vous %}
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">Dr. {{ rdv.medecin.user.get_full_name }}</h6>
                                    <small>{{ rdv.date_heure|date:"d/m/Y H:i" }}</small>
                                </div>
                                <p class="mb-1">{{ rdv.motif }}</p>
                                <small class="text-muted">Statut: {{ rdv.get_statut_display }}</small>
                            </div>
                        {% empty %}
                            <div class="text-center text-muted py-3">
                                Aucun rendez-vous à venir
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialisation de la carte
    let map = L.map('map', {
        center: [48.8566, 2.3522],
        zoom: 13,
        zoomControl: true,
        attributionControl: true
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Données des professionnels
    const medecins = {{ medecins|default:"[]"|safe }};
    const pharmacies = {{ pharmacies|default:"[]"|safe }};
    const laboratoires = {{ laboratoires|default:"[]"|safe }};

    // Icônes personnalisées
    const medecinIcon = L.divIcon({
        html: '<i class="fas fa-user-md" style="color: #007bff;"></i>',
        className: 'custom-icon',
        iconSize: [20, 20]
    });

    const labIcon = L.divIcon({
        html: '<i class="fas fa-flask" style="color: #28a745;"></i>',
        className: 'custom-icon',
        iconSize: [20, 20]
    });

    const pharmaIcon = L.divIcon({
        html: '<i class="fas fa-prescription-bottle-alt" style="color: #fd7e14;"></i>',
        className: 'custom-icon',
        iconSize: [20, 20]
    });

    // Fonction pour créer le contenu du popup
    function createPopupContent(pro) {
        let content = `<div class="popup-content">`;
        if (pro.type === 'medecin') {
            content += `<h6>Dr. ${pro.specialite}</h6>`;
        } else if (pro.type === 'laboratoire') {
            content += `<h6>Laboratoire</h6>`;
        } else {
            content += `<h6>Pharmacie</h6>`;
        }
        content += `<p>${pro.adresse}</p>`;
        content += `<p><i class="fas fa-phone"></i> ${pro.telephone}</p>`;
        content += `</div>`;
        return content;
    }

    // Ajouter les marqueurs pour chaque type de professionnel
    medecins.forEach(pro => {
        if (pro.latitude && pro.longitude) {
            L.marker([pro.latitude, pro.longitude], {icon: medecinIcon})
                .bindPopup(createPopupContent(pro))
                .addTo(map);
        }
    });

    pharmacies.forEach(pro => {
        if (pro.latitude && pro.longitude) {
            L.marker([pro.latitude, pro.longitude], {icon: pharmaIcon})
                .bindPopup(createPopupContent(pro))
                .addTo(map);
        }
    });

    laboratoires.forEach(pro => {
        if (pro.latitude && pro.longitude) {
            L.marker([pro.latitude, pro.longitude], {icon: labIcon})
                .bindPopup(createPopupContent(pro))
                .addTo(map);
        }
    });

    // Géolocalisation de l'utilisateur
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            
            // Centrer la carte sur la position de l'utilisateur
            map.setView([userLat, userLng], 13);
            
            // Ajouter un marqueur pour la position de l'utilisateur
            L.marker([userLat, userLng], {
                icon: L.divIcon({
                    html: '<i class="fas fa-user" style="color: #dc3545;"></i>',
                    className: 'custom-icon',
                    iconSize: [20, 20]
                })
            }).addTo(map).bindPopup('Votre position').openPopup();
            
            // Ajouter un cercle de 5km autour de l'utilisateur
            L.circle([userLat, userLng], {
                color: '#dc3545',
                fillColor: '#dc3545',
                fillOpacity: 0.1,
                radius: 5000
            }).addTo(map);
        }, function(error) {
            console.error('Erreur de géolocalisation:', error);
        });
    }

    // Forcer le rafraîchissement de la carte
    setTimeout(() => {
        map.invalidateSize();
    }, 100);

    // Gestion du chat
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const chatContainer = document.getElementById('chatContainer');

    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (!message) return;

        // Ajouter le message de l'utilisateur
        const userMessageDiv = document.createElement('div');
        userMessageDiv.className = 'message user-message';
        userMessageDiv.innerHTML = `
            <div class="message-content">${message}</div>
            <div class="message-avatar"><i class="fas fa-user"></i></div>
        `;
        chatContainer.appendChild(userMessageDiv);

        // Envoyer le message au serveur
        fetch('/patient/chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': $.cookie('csrftoken')
            },
            body: JSON.stringify({ message: message })
        })
        .then(response => response.json())
        .then(data => {
            if (data.response) {
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.className = 'message ai-message';
                aiMessageDiv.innerHTML = `
                    <div class="message-avatar"><i class="fas fa-robot"></i></div>
                    <div class="message-content">${data.response}</div>
                `;
                chatContainer.appendChild(aiMessageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        })
        .catch(error => console.error('Erreur:', error));

        messageInput.value = '';
        chatContainer.scrollTop = chatContainer.scrollHeight;
    });
});
</script>
{% endblock %} 